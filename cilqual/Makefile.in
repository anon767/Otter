CIL_SRCDIR = @CIL_SRCDIR@
OCAMLBUILD = @OCAMLBUILD@
OCAMLFIND = @OCAMLFIND@
EXTRALIBDIRS = @EXTRALIBDIRS@

include $(CIL_SRCDIR)/config.mk

CIL_OBJDIR = $(CILHOME)/obj/$(ARCHOS)

OCAMLBUILD_CIL = -cflags -I,$(CIL_OBJDIR) -lflags -I,$(CIL_OBJDIR) -tags pkg_unix,pkg_str -libs stpvc,cil
OCAMLBUILD_PA_MONAD = -X pa_monad -tag syntax_camlp4o -tag pkg_pa_monad
OCAMLBUILD_GRAPH = -X ocamlgraph -tag pkg_ocamlgraph
OCAMLBUILD_OUNIT = -tag pkg_oUnit

OCAMLBUILD_FLAGS = -j 0 -X experiments
OCAMLBUILD_FLAGS += $(OCAMLBUILD_CIL) $(OCAMLBUILD_PA_MONAD) $(OCAMLBUILD_GRAPH)
OCAMLBUILD_FLAGS += $(EXTRALIBDIRS:%=-lflags -I,%) $(OCAMLBUILD_EXTRAFLAGS)
export OCAMLPATH:=$(CURDIR):$(OCAMLPATH)

OCAMLBUILD_DEPS = pa_monad ocamlgraph

VPATH = src

.PHONY : all native debug config test

all : native

native : ocamlbuild//runcilqual.native config
debug : ocamlbuild//runcilqual.d.byte config
config : cilqual.pl.config
test : ounit//runtestcilqual.d.byte

ounit//runtestcilqual.d.byte : OCAMLBUILD_FLAGS += $(OCAMLBUILD_OUNIT)
ounit//runtestcilqual.d.byte : OUNIT_FLAGS = -verbose
ounit//runtestcilqual.d.byte : VPATH += test

pa_monad : pa_monad/pa_monad.cmo
pa_monad/pa_monad.cmo : make//pa_monad
make//pa_monad : MAKEGOALS=all META

ocamlgraph : ocamlgraph/graph.cma ocamlgraph/graph.cmxa
ocamlgraph/graph.cma ocamlgraph/graph.cmxa : make//ocamlgraph

cilqual.pl.config : Makefile $(CIL_SRCDIR)/config.mk
	printf "\
	$$::cilhome = '$(CILHOME)';\n\
	$$::cc  = '$(CC)';\n\
	$$::default_mode = '$(DEFAULT_CIL_MODE)';\n\
	$$::native = 'runcilqual.native';\n\
	$$::byte = 'runcilqual.d.byte';\n\
	$$::do_default = '--docilqual';\n\
	$$::compile_after_merge = 0;\n\
	1;" > $@

clean : clean-cilqual
	$(MAKE) -C pa_monad clean
	$(MAKE) -C ocamlgraph clean

clean-cilqual :
	$(OCAMLBUILD) -clean
	$(RM) cilqual.pl.config *.native *.byte

distclean : clean-cilqual
	$(MAKE) -C pa_monad distclean
	$(MAKE) -C ocamlgraph distclean
	$(RM) config.cache config.log config.status

maintainer-clean : distclean
	$(RM) Makefile
	$(RM) -r auto4mate.cache

include Makefile.rules
