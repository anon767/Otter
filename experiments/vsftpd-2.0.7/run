VSFTPDFILES="main.c utility.c prelogin.c ftpcmdio.c postlogin.c privsock.c tunables.c ftpdataio.c secbuf.c ls.c postprivparent.c logging.c str.c netstr.c sysstr.c strlist.c banner.c filestr.c parseconf.c secutil.c ascii.c oneprocess.c privops.c standalone.c hash.c tcpwrap.c ipaddrparse.c access.c features.c readwrite.c opts.c ssl.c sysutil.c sysdeputil.c"
# twoprocess.c

STATSFILE=vsftpd.stats

if [[ "$1" == stats ]]; then
	CILLY_DONT_COMPILE_AFTER_MERGE= \
	../../cil/bin/cilly --merge --dofindFns \
		--fnOutfile=$STATSFILE $VSFTPDFILES
	exit
fi

TOPDIR=../..
LIBCDIR=$TOPDIR/libc
MOCKEDDIR=$TOPDIR/mockedFns

if [[ "$1" == merge ]]; then
	shift
	../../cil/bin/cilly --merge --warnall --useLogicalOperators --disallowDuplication \
		-I $LIBCDIR $LIBCDIR/*.c \
		-D_FILE_OFFSET_BITS=64 \
		-I $MOCKEDDIR -include $MOCKEDDIR/symexe.h $MOCKEDDIR/*.c \
		$VSFTPDFILES --out=vsftpd_comb.c $*
elif [[ "$1" == mergeUnfolded ]]; then
	shift
	echo 'Merging vsftpd alone (without logical operators)'
	../../cil/bin/cilly --merge --warnall --disallowDuplication \
		-D_FILE_OFFSET_BITS=64 \
		$VSFTPDFILES --out=vsftpdAlone_unfolded.c $*
	echo 'Now merging in libc and mocked functions (with logical operators)'
	../../cil/bin/cilly --merge --warnall --useLogicalOperators --disallowDuplication \
		-I $LIBCDIR $LIBCDIR/*.c \
		-D_FILE_OFFSET_BITS=64 \
		-I $MOCKEDDIR -include $MOCKEDDIR/symexe.h $MOCKEDDIR/*.c \
		vsftpdAlone_unfolded.c --out=vsftpd_comb_unfolded.c $*
	rm vsftpdAlone_unfolded.c
else
	../../cil/bin/cilly --merge --warnall --disallowDuplication \
		-D_FILE_OFFSET_BITS=64 \
		-I $MOCKEDDIR \
		vsftpd_comb.c --covStats=$STATSFILE --doexecute $*
fi
