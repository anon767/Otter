VSFTPDFILES="main.c utility.c prelogin.c ftpcmdio.c postlogin.c privsock.c tunables.c ftpdataio.c secbuf.c ls.c postprivparent.c logging.c str.c netstr.c sysstr.c strlist.c banner.c filestr.c parseconf.c secutil.c ascii.c oneprocess.c twoprocess.c privops.c standalone.c hash.c tcpwrap.c ipaddrparse.c access.c features.c readwrite.c opts.c ssl.c sysutil.c sysdeputil.c"

STATSFILE=vsftpd.stats

if [ "$1" == stats ]; then
	../../cil/bin/cilly --merge --useLogicalOperators --doprogStats \
		--statsFile=$STATSFILE $VSFTPDFILES
	exit
fi

TOPDIR=../..
LIBCDIR=$TOPDIR/libc
MOCKEDDIR=$TOPDIR/mockedFns

if [ "$1" == merge ]; then
	shift
	../../cil/bin/cilly --merge --useLogicalOperators \
		-I $LIBCDIR $LIBCDIR/*.c \
		-D_FILE_OFFSET_BITS=64 \
		-I $MOCKEDDIR -include $MOCKEDDIR/symexe.h $MOCKEDDIR/*.c \
		$VSFTPDFILES --warnall --out=vsftpd_comb.c $*
else
	../../cil/bin/cilly --merge --useLogicalOperators \
		-D_FILE_OFFSET_BITS=64 \
		-I $MOCKEDDIR \
		vsftpd_comb.c --covStats=$STATSFILE --doexecute $*
fi
