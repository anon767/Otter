if [[ "$1" == clean ]]; then
  make clean
  cmd='rm -rf src/*_comb.c src/___extra_files deps/hiredis/libhiredis.a deps/linenoise/linenoise_example_comb.c redis-functions'
  echo $cmd
  $cmd
  exit 0
fi

# This forces redis to use malloc, free, etc., instead of zmalloc, zfree, etc.
zmalloc='-DNO_ZMALLOC -Dzmalloc=malloc -Dzrealloc=realloc -D"zcalloc(size)=calloc(1,size)" -Dzfree=free -Dzstrdup=strdup'

if [[ "$1" == zmalloc ]]; then
  # Use zmalloc, zfree, etc.
  zmalloc=
elif [[ -n "$1" ]]; then
  echo Unknown command: "$1"
  exit 1
fi

OTTER_TRUNK=`pwd`/../.. make CC="\${OTTER_TRUNK}/newlib-1.19.0/otter/cilly-with-libc $zmalloc" uname_S= AR='${OTTER_TRUNK}/cil/bin/cilly --merge --mode=AR'

cmd='../../otter/otter.pl --dofindFns src/redis-server_comb.c'
echo $cmd '> redis-functions'
$cmd > redis-functions

echo ../../otter/src/OcamlUtilities/Grammar/grammar '< redis.grammar > redis-grammar.c'
../../otter/src/OcamlUtilities/Grammar/grammar < redis.grammar > redis-grammar.c
