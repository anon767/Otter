CIL_SRCDIR = @CIL_SRCDIR@
EXTRALIBDIRS = @EXTRALIBDIRS@

include $(CIL_SRCDIR)/config.mk

CIL_OBJDIR = $(CILHOME)/obj/$(ARCHOS)

OCAMLBUILD_CIL = -cflags -I,$(CIL_OBJDIR) -lflags -I,$(CIL_OBJDIR) -tags pkg_unix,pkg_str -libs cil
OCAMLBUILD_OTTER = -tags pkg_ocaml-base-noparser -libs stpvc
OCAMLBUILD_OUNIT = -tags pkg_oUnit

OCAMLBUILD_FLAGS = -j 0 -Xs doc,examples,libc,util -tags warn_error_A,quiet,dot_reduce
OCAMLBUILD_FLAGS += $(OCAMLBUILD_CIL) $(OCAMLBUILD_OTTER) $(OCAMLBUILD_OUNIT)
OCAMLBUILD_FLAGS += $(EXTRALIBDIRS:%=-cflags -I,%) $(EXTRALIBDIRS:%=-lflags -I,%) $(OCAMLBUILD_EXTRAFLAGS)
export OCAMLPATH:=$(CURDIR):@EXTRAOCAMLPATH@

OCAMLBUILD_DEPS = \
	configure Makefile Makefile.rules \
	$(EXTRALIBDIRS)/* $(CIL_OBJDIR)

OUNIT_FLAGS = -verbose

VPATH = src test

.PHONY : all native debug config test experiments

all : native libs doc

native : ocamlbuild//runotter.native config
debug : ocamlbuild//runotter.d.byte config

libs : ocamlbuild//Otter.cmxa ocamlbuild//Otter.a ocamlbuild//Otter.cma ocamlbuild//Otter.cmi \
		ocamlbuild//OtterBytes.cmxa ocamlbuild//OtterBytes.a ocamlbuild//OtterBytes.cma ocamlbuild//OtterBytes.cmi \
		ocamlbuild//OcamlUtilities.cmxa ocamlbuild//OcamlUtilities.a ocamlbuild//OcamlUtilities.cma ocamlbuild//OcamlUtilities.cmi

test : ounit//runtestotter.d.byte
ounit//runtestotter.d.byte : debug

config : otter.pl.config
otter.pl.config : Makefile $(CIL_SRCDIR)/config.mk
	printf "\
	$$::cilhome = '$(CILHOME)';\n\
	$$::cc  = '$(CC)';\n\
	$$::default_mode = '$(DEFAULT_CIL_MODE)';\n\
	$$::native = '$(OCAMLBUILD_PRODUCTDIR)/runotter.native';\n\
	$$::byte = '$(OCAMLBUILD_PRODUCTDIR)/runotter.d.byte';\n\
	$$::do_default = '--doexecute';\n\
	$$::compile_after_merge = 0;\n\
	1;" > $@

doc : ocamlbuild//CilUtilities.docdir ocamlbuild//DataStructures.docdir ocamlbuild//OcamlUtilities.docdir \
		ocamlbuild//OtterBytes.docdir ocamlbuild//Otter.docdir ocamlbuild//TestUtil.docdir

clean : clean-ocamlbuild
	$(RM) otter.pl.config

distclean : clean
	$(RM) config.cache config.log config.status

maintainer-clean : distclean
	$(RM) Makefile
	$(RM) -r auto4mate.cache

include Makefile.rules
